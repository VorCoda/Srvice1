# Лаб.номер 4. Мультистейджинг, различные уровни зависимостей

**Использовал чужой проект на golang:**
[https://github.com/geetarista/go-http-hello-world](https://github.com/geetarista/go-http-hello-world)


1. Переходим в директорию лаб4
2. Копируем репоз. 
```git clone https://github.com/geetarista/go-http-hello-world.git ./src```

  **Собираем образы в ручную в нужном порядке**<br>
3. ```docker build -f system -t lab04-system:latest . ```
4. ```docker build --build-arg NAME=hello --build-arg SRC=src -f build -t lab04-build:latest . ```
5. ```docker build --build-arg NAME=hello -f Dockerfile -t lab04-app:latest . ```

6. Запускаем контейнер с образом lab04-app:
 ```docker run --name lab04-hello --env APP_NAME=hello -d -p 8082:80 lab04-app```

7. Используем [http://localhost:**8082**](http://localhost:**8082**) для проверки работоспособности

**Цель лабораторной: освоить методы создания образов с разными уровнями зависимостей**

1. Создать Dockerfile, который будет называться system. В него будут установлены все зависимости для сборки проекта. Как пример голая node нужной версии.
2. Создать Dockerfile Для сборки и назвать его build. В нем будет собираться проект, он должен использовать имейдж system. В build нельзя устанавливать никакие дополнительные зависимости, т.е. apk add, apt install и пр. запрещены. В нём можно только скачивать зависимости и делать сборку проекта.
3. Создать Dockerfile, который будет запускать код , который собрался в build. В нем должен быть только инструмент для запуска вашего проекта, как пример для node проекта - npm run start и пр. Если у вас python проект - объединять 2 и 3 шаги - можно. Если вы билдите проект на GO - тогда должен быть только бинарник для запуска.
4. Вся конфигурация выполняется через переменные окружения
5. Использовать базовые легковесный образ – alpine
6. Контейнер должен запускаться от непривилегированного пользователя
7. После установки всех нужных утилит,	должен очищаться кеш

## Dockerfile - System
>Выбрал golang , для выбранного мною приложения не нужные никакие зависимости,
поэтому в system просто устанавливаю базовый образ
```
FROM golang:alpine AS lab04-system
```

## Dockerfile - Build
>Беру из моего докерфайла систем голанг образ
```
FROM lab04-system AS lab04-build
```

>Задаю аргуменыт сборки имя проекта и папку "источник" на хосте
```
ARG NAME="hello"
ARG SRC="./src"
```

>Передаю в переменные окружения 
```
ENV APP_NAME=$NAME
ENV APP_SRC=$SRC
```

>Для билда go файла задаем переменные окруж.
```
ENV GO_OS=linux
```
>Параметр для сборки под процессор
```
ENV GO_ARCH=amd64
```

>Go будет автоматически решать, использовать ли модули или нет, в зависимости от контекста
```
ENV GO111MODULE=auto
```

>Устанавливаем директорию  для исполняемого бинарника /var/hello
```
RUN mkdir -p "/var/$APP_NAME" 
```

>Даем права только на чтение(444)
```
RUN chmod 444 "/var/$APP_NAME"
```

>Устанавливаем временну директорию нашего билда
```
WORKDIR /tmp/golang/$APP_NAME/build
```

>Копируем содержимое указанной папки с исходным кодом с хоста  в workdir 
```
COPY  ./${APP_SRC}/* .
```   


>собираем исполняемый файл-бинарник из текущей workdir  и кладем в /var/hello/hello
```
RUN go build -o "/var/$APP_NAME/$APP_NAME" .
```

## Dockerfile - App

>Берем легковесный образ
```
FROM alpine
```

>Задаем аргументы сборки
```
ARG NAME="hello"
```

>Передаем в перемен. окружения
```
ENV APP_NAME=${NAME}
```

>Создаем новую группу пользоватлей, нового пользователя
```
RUN addgroup -g 2025 servicegroup && \
    adduser -u 2025 -G servicegroup -s /bin/sh -D serviceuser
```

>Делаем текущим нашего пользователя
```
USER serviceuser
```

>Устанавливаем директорию (текущая папка для бинарника)
```
WORKDIR /opt/${APP_NAME}
```

> копируем бинарник golang из образа build (/var/hello/hello) в workdir и меняем ему собственника на текущ. пользователя 
```
COPY --from=lab04-build:latest --chown=serviceuser:servicegroup /var/${APP_NAME}/${APP_NAME} .
```

>Приложение слушает порт 80
```
EXPOSE 80
```

>надо запускать в шеле, т.к берем имя параметра из перем. окружения(шел отвечает за загрузку параметров окр.)
``` 
CMD ["sh", "-c", "./${APP_NAME}"]
```

